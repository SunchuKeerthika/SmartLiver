<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMART on FHIR App - Patient Growth Charts</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .container {
            width: 100%;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .notification {
            color: blue;
            cursor: pointer;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Patient Growth Charts</h1>
    <div id="patient-info"></div>
    <div id="error-info" style="color: red;"></div>
    <table id="patient-table">
        <thead>
            <tr>
                <th>Name</th>
                <th>MRN</th>
                <th>Labs</th>
                <th>Visit Reason</th>
                <th>Recent Visit</th>
                <th>Patient Communication</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    const patientInfo = document.getElementById('patient-info');
    const errorInfo = document.getElementById('error-info');
    const patientTable = document.getElementById('patient-table').querySelector('tbody');

    FHIR.oauth2.ready()
        .then(client => {
            console.log("FHIR client initialized:", client);
            return Promise.all([
                client.patient.read(),
                client.request(`Observation?patient=${client.patient.id}&code=http://loinc.org|8302-2,http://loinc.org|29463-7&_sort=date`)
            ]);
        })
        .then(([patient, observations]) => {
            console.log("Patient data received:", patient);
            console.log("Observations received:", observations);

            const patientData = {
                name: `${patient.name[0].given.join(' ')} ${patient.name[0].family}`,
                mrn: patient.identifier[0].value,
                labs: 'Incomplete', // Placeholder for labs status
                visitReason: 'N/A', // Placeholder for visit reason
                recentVisit: 'N/A', // Placeholder for recent visit
                communication: 'Send Notification' // Placeholder for communication action
            };

            // Sample data population
            const samplePatients = Array(12).fill(patientData);

            samplePatients.forEach(p => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${p.name}</td>
                    <td>${p.mrn}</td>
                    <td>${p.labs}</td>
                    <td>${p.visitReason}</td>
                    <td>${p.recentVisit}</td>
                    <td><span class="notification">${p.communication}</span></td>
                `;
                patientTable.appendChild(row);
            });

        })
        .catch(error => {
            console.error("Error occurred:", error);
            errorInfo.innerHTML = `<p>Error: ${error.message}</p>`;
            if (error.stack) {
                errorInfo.innerHTML += `<pre>${error.stack}</pre>`;
            }
        });
</script>
</body>
</html>
